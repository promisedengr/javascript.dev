SELECT First_airport, Final_airport, min(fare) as total_cost
FROM (
SELECT
f1.origin AS First_airport,
f1.destination AS Mid_airport1,
f2.destination AS Mid_airport2,
coalesce(f3.destination, f2.destination, f1.destination) as Final_airport,
f1.cost + coalesce( f2.cost, 0) + coalesce( f3.cost, 0) as fare
FROM
flights f1 LEFT JOIN flights f2 ON
f1.destination = f2.origin LEFT JOIN  flights f3 ON
f2.destination = f3.origin
UNION ALL SELECT
origin, '', '', destination, cost FROM flights
) t
GROUP BY First_airport, Final_airport